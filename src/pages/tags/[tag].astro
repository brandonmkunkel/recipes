---
import { getCollection } from 'astro:content'

import Layout from '~/layouts/Layout.astro'
import Header from '~/components/Header.astro'
import SearchBar from '~/components/SearchBar.astro'

export async function getStaticPaths() {
  const recipes = await getCollection('recipes')
  const tags = new Set()

  for (const r of recipes) {
    const t = r.data.tags ?? []
    for (const tag of t) tags.add(tag)
  }

  return Array.from(tags).map((tag) => ({ params: { tag }, props: { tag } }))
}

const { tag } = Astro.props

const recipes = await getCollection('recipes')
const matched = recipes
  .filter((r) => (r.data.tags ?? []).includes(tag))
  .sort((a, b) => (a.data.title ?? a.id).localeCompare(b.data.title ?? b.id))
---

<Layout title={`Tag: ${tag}`}>
  <Header />
  <SearchBar />

  <main>
    <h1>Tag: {tag}</h1>
    {
      matched.length === 0 ? (
        <p>No recipes found for this tag.</p>
      ) : (
        <ul>
          {matched.map((r) => (
            <li>
              <a href={`/recipes/${r.id}/`}>{r.data.title ?? r.id}</a>
            </li>
          ))}
        </ul>
      )
    }
  </main>
</Layout>

<style>
  main {
    max-width: 800px;
    margin: 0 auto;
    padding: 1rem;
  }

  h1 {
    margin-bottom: 1rem;
  }

  ul {
    list-style: none;
    padding: 0;
  }

  li {
    margin: 0.5rem 0;
  }
</style>
